!function(){"use strict";var n=function(n){var c;if(n=n||"fabric",(c="undefined"!=typeof Buffer&&"undefined"==typeof window?require(n).fabric:window.fabric).FontManager)c.warn("fabric.FontManager is already defined");else{var s,a;if(c.isLikelyNode)try{s=require("canvas"),a=require("webfontloader")}catch(n){}else a=c.window.WebFont;var u=function(n){return"[object Array]"===Object.prototype.toString.call(n)},d=function(n){return"object"==typeof n&&n},l=function(n){return"string"==typeof n},o=function(n){if(n.target){var e=this,t=n.target,r=c.FontManager.getCanvasFonts(t),o=function(n){e.trigger("fontmanager:canvas.load.font",{target:n})};c.FontManager.applyFonts(r).then(o).catch(o)}};c.FontManager=c.util.createClass({}),c.FontManager._fonts=[],c.FontManager.deregisterCanvases=function(t){return t=u(t)?t:[],new Promise(function(n,e){return Promise.all(t.map(function(n){return c.FontManager.deregisterCanvas(n)})).then(function(){n()}).catch(function(n){e(n)})})},c.FontManager.deregisterCanvas=function(r){return new Promise(function(n,e){if(!(r instanceof c.StaticCanvas))return e(new Error("[fabric.FontManager] invalid `canvas`"));var t;(t=r,new Promise(function(n,e){if(!(t instanceof c.StaticCanvas))return e(new Error("[fabric.FontManager] invalid `canvas`"));t.off("object:added",o.bind(t)),n()})).then(function(){"function"==typeof r._fabricOrigLoadFromJSON&&(r.loadFromJSON=r._fabricOrigLoadFromJSON.bind(r),r._fabricOrigLoadFromJSON=null,delete r._fabricOrigLoadFromJSON),"function"==typeof r._fabricOrigDispose&&(r.dispose=r._fabricOrigDispose.bind(r),r._fabricOrigDispose=null,delete r._fabricOrigDispose),n()}).catch(function(n){e(n)})})},c.FontManager.registerCanvases=function(t){return t=u(t)?t:[],new Promise(function(n,e){return Promise.all(t.map(function(n){return c.FontManager.registerCanvas(n)})).then(function(){n()}).catch(function(n){e(n)})})},c.FontManager.registerCanvas=function(e){return new Promise(function(n){var t;"function"==typeof e.loadFromJSON&&("function"!=typeof e._fabricOrigLoadFromJSON&&(e._fabricOrigLoadFromJSON=e.loadFromJSON.bind(e)),e.loadFromJSON=function(o,a,i){o=l(o)?JSON.parse(o):c.util.object.clone(o);var f=this;return new Promise(function(n,e){var t=c.FontManager.getCanvasFonts(o),r=function(){a&&a(),n()};c.isLikelyNode?"function"==typeof f._fabricOrigLoadFromJSON&&f._fabricOrigLoadFromJSON(o,r,i):c.FontManager.applyFonts(t).then(function(n){f.trigger("fontmanager:canvas.load.fonts",{target:n})}).then(function(){"function"==typeof f._fabricOrigLoadFromJSON&&f._fabricOrigLoadFromJSON(o,r,i)}).catch(function(n){"function"==typeof f._fabricOrigLoadFromJSON&&f._fabricOrigLoadFromJSON(o,a,i),e(n)})})}.bind(e)),"function"==typeof e.dispose&&("function"!=typeof e._fabricOrigDispose&&(e._fabricOrigDispose=e.dispose.bind(e)),e.dispose=function(){var t=this;return new Promise(function(n,e){c.FontManager.dispose().then(function(){"function"==typeof t._fabricOrigDispose&&t._fabricOrigDispose(),n()}).catch(function(n){"function"==typeof t._fabricOrigDispose&&t._fabricOrigDispose(),e(n)})})}.bind(e)),t=e,new Promise(function(n,e){if(!(t instanceof c.StaticCanvas))return e(new Error("[fabric.FontManager] invalid `canvas`"));t.on("object:added",o.bind(t)),n()}),n()})},c.FontManager.getCanvasFonts=function(n){var e=[];if(!d(n))return e;var f=function(n){l(n)&&n&&-1===e.indexOf(n)&&e.push(n)},c=function(n){if(u(n.objects)||u(n._objects))for(var e=n.objects||n._objects,t=0;t<e.length;++t)c(e[t]);else if(f(n.fontFamily),d(n.styles))for(var r in n.styles){var o=n.styles[r];for(var a in o){var i=o[a];d(i)&&f(i.fontFamily)}}};return c(n),e},c.FontManager.hasFont=function(n){return 0<=c.FontManager._fonts.indexOf(n)},c.FontManager.applyFont=function(n,e){return c.FontManager.applyFonts([n],e)},c.FontManager.applyFonts=function(r,o){return new Promise(function(n,e){var t={loadedFonts:[],failedFonts:[]};if(r=(r=u(r)?r:[]).filter(function(n,e){return!c.FontManager.hasFont(n)&&r.indexOf(n)===e}),(o=d(o)?o:{}).custom=d(o.custom)?o.custom:{},o.custom.families=u(o.custom.families)?o.custom.families:[],o.custom.families=o.custom.families.concat(r),!o.custom.families.length)return n(t);o.active=function(){n(t)},o.inactive=function(){n(t)},o.fontactive=function(n){-1===t.loadedFonts.indexOf(n)&&t.loadedFonts.push(n),c.FontManager.hasFont(n)||c.FontManager._fonts.push(n)},o.fontinactive=function(n){-1===t.failedFonts.indexOf(n)&&t.failedFonts.push(n)};try{a.load(o)}catch(n){e(n)}})},c.FontManager.registerFont=function(i,f){return new Promise(function(n,e){if(i=l(i)?i:"",f=l(f)?f:"",!i)return e(new Error("[fabric.FontManager] invalid `font`"));if(!f)return e(new Error("[fabric.FontManager] invalid `src`"));if(c.isLikelyNode)return s.registerFont(f,{family:i}),n();var t=f.match(/\.([a-zA-Z0-9]+)(\?.*)?$/i);if(!f.match(/^http(s)?:\/\//i)||!t)return e(new Error("[fabric.FontManager] invalid external src"));var r="";switch(t[1].toLowerCase()){case"eot":r="embedded-opentype";break;case"woff2":r="woff2";break;case"woff":r="woff";break;case"ttf":r="truetype";break;case"otf":r="opentype";break;case"svg":r="svg"}if(!r)return e(new Error("invalid `srcFormat`"));var o=c.document.createElement("style");o.type="text/css",o.appendChild(c.document.createTextNode("")),c.document.head.appendChild(o);var a="@font-face {"+("font-family: '"+i+"';")+("src: url('"+f+"') format('"+r+"')")+"}";o.styleSheet?o.styleSheet.cssText=a:o.appendChild(c.document.createTextNode(a)),c.document.head.appendChild(o),n()})},c.FontManager.applyExtStylesheet=function(r){return new Promise(function(n,e){if(!(r=l(r)?r:"").match(/^http(s)?:\/\//i))return e(new Error("[fabric.FontManager] invalid `stylesheet`"));var t=c.document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=r,c.document.head.appendChild(t),n()})},c.FontManager.applyExtStylesheets=function(n){var r=this;return new Promise(function(e,t){Promise.all(n.map(function(n){return r.applyExtStylesheet(n)})).then(function(n){e(n)}).catch(function(n){t(n)})})},c.FontManager.dispose=function(t){return new Promise(function(n){if(!(t="string"==typeof t?t:""))return c.FontManager._fonts.length=0,n();var e=c.FontManager._fonts.indexOf(t);if(-1===e)return n();c.FontManager._fonts.splice(e,1),n()}).then(function(){c.util.clearFabricFontCache(t)})}}};"undefined"!=typeof module&&void 0!==module.exports?module.exports=n:n()}();